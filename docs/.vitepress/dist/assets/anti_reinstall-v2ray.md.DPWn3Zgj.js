import{_ as n,c as e,J as l,w as t,a4 as a,E as p,o as h,m as s}from"./chunks/framework.iZPUC10f.js";const B=JSON.parse('{"title":"重装 v2ray - WS + TLS + Web + CloudFlare","description":"","frontmatter":{},"headers":[],"relativePath":"anti/reinstall-v2ray.md","filePath":"anti/reinstall-v2ray.md","lastUpdated":1710679796000}'),r={name:"anti/reinstall-v2ray.md"},o=a(`<h1 id="重装-v2ray-ws-tls-web-cloudflare" tabindex="-1">重装 v2ray - WS + TLS + Web + CloudFlare <a class="header-anchor" href="#重装-v2ray-ws-tls-web-cloudflare" aria-label="Permalink to &quot;重装 v2ray - WS + TLS + Web + CloudFlare&quot;">​</a></h1><h2 id="序" tabindex="-1">序 <a class="header-anchor" href="#序" aria-label="Permalink to &quot;序&quot;">​</a></h2><p>2023/8/30，今天翻墙服务器突然就没用了。</p><p>首先在 <a href="https://ping.pe/" target="_blank" rel="noreferrer">ping.pe</a> 确认一下是不是我的服务器 IP 地址被墙了：</p><p><img src="https://cdn.tangjiayan.com/reinstall-v2ray/1-ping.be.png" alt="ping.be"></p><p>我是江苏电信网络，从图中可以看到，<code>Jiangsu China Telecom</code> 的丢包率是 <code>15%</code>，还算正常。因此问题出在我的服务器或客户端上。</p><p>尝试了以下方案，都没有用：</p><ul><li>更新服务器端、更新客户端</li><li>更换服务器端 v2ray 端口</li><li>重设 服务器时间（v2ray 要求服务器和客户端时间差绝对值不能超过 90 秒，参见 <a href="https://guide.v2fly.org/prep/start.html#%E6%97%B6%E9%97%B4%E6%98%AF%E5%90%A6%E5%87%86%E7%A1%AE" target="_blank" rel="noopener">这里</a>）</li></ul><p>所以干脆重装一下 v2ray 吧。</p><p>根据 <a href="https://github.com/v2fly/v2ray-examples/tree/master/how-to-choose#%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9-v2ray-%E6%96%B9%E6%A1%88">如何选择 v2ray 方案</a> 考虑了一下，决定采用 <code>Nginx</code> + <code>TLS</code> + <code>WS</code>。于是主要参考 <a href="https://ericclose.github.io/V2Ray-TLS-WebSocket-Nginx-with-Cloudflare.html" target="_blank" rel="noreferrer">V2Ray (WebSocket + TLS + Web + Cloudflare) 手动配置详细说明 - Eric</a> 重装了一下 v2ray。</p><p>本文略去了：</p><ul><li>服务器购买及 SSH 连接</li><li>域名购买注册</li></ul><h2 id="重装服务器系统为-debian-10" tabindex="-1">重装服务器系统为 Debian 10 <a class="header-anchor" href="#重装服务器系统为-debian-10" aria-label="Permalink to &quot;重装服务器系统为 Debian 10&quot;">​</a></h2><p>首先更新一下系统，我的服务器系统是 <code>CentOS 7.9.2009</code>，有点旧了。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/redhat-release</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CentOS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Linux</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> release</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 7.9</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.2009</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (Core)</span></span></code></pre></div><p>我的服务器是在 <a href="https://www.racknerd.com/" target="_blank" rel="noreferrer">RackNerd</a> 买的，在 RackNerd 服务器管理界面进入 <code>Control Panel</code>（登入Control Panel 的初始账号密码在购买服务器时发送到了注册邮箱），将服务器系统重置为 <code>Debian 10</code>。</p><p><img src="https://cdn.tangjiayan.com/reinstall-v2ray/2-reinstall-Debian.png" alt="reinstall-Debian"></p><h2 id="v2ray-安装前准备及安装" tabindex="-1">v2ray 安装前准备及安装 <a class="header-anchor" href="#v2ray-安装前准备及安装" aria-label="Permalink to &quot;v2ray 安装前准备及安装&quot;">​</a></h2><p>以下过程均是以 <code>root</code> 身份运行的。</p><p>最好不要这样，因为一旦手滑 <code>rm -rf /*</code> 就不好了。所以最好用非 root 用户，通过 <code>sudo</code> 执行 root 指令。</p><h3 id="更新-apt、安装-curl" tabindex="-1">更新 apt、安装 curl <a class="header-anchor" href="#更新-apt、安装-curl" aria-label="Permalink to &quot;更新 apt、安装 curl&quot;">​</a></h3><p>重装好系统后，先更新一下 <a href="https://en.wikipedia.org/wiki/APT_(software)" target="_blank" rel="noreferrer">apt</a>，安装 <a href="https://en.wikipedia.org/wiki/CURL" target="_blank" rel="noreferrer">curl</a></p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apt-get</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --allow-releaseinfo-change</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> update</span></span></code></pre></div><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apt-get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dist-upgrade</span></span></code></pre></div><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apt-get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -y</span></span></code></pre></div><h3 id="校正系统时间" tabindex="-1">校正系统时间 <a class="header-anchor" href="#校正系统时间" aria-label="Permalink to &quot;校正系统时间&quot;">​</a></h3><p>v2ray 要求服务器和客户端时间差绝对值不能超过90 秒，参见 <a href="https://guide.v2fly.org/prep/start.html#%E6%97%B6%E9%97%B4%E6%98%AF%E5%90%A6%E5%87%86%E7%A1%AE" target="_blank" rel="noopener">这里</a></p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">timedatectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> list-timezones</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Shanghai</span></span></code></pre></div><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">timedatectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> set-timezone</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Asia/Shanghai</span></span></code></pre></div><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">date</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -R</span></span></code></pre></div><h3 id="安装-ufw" tabindex="-1">安装 ufw <a class="header-anchor" href="#安装-ufw" aria-label="Permalink to &quot;安装 ufw&quot;">​</a></h3><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ufw</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ufw</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> enable</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ufw</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> allow</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;OpenSSH&#39;</span></span></code></pre></div><h3 id="安装-v2ray" tabindex="-1">安装 v2ray <a class="header-anchor" href="#安装-v2ray" aria-label="Permalink to &quot;安装 v2ray&quot;">​</a></h3><p>通过 <a href="https://github.com/v2fly/fhs-install-v2ray" target="_blank" rel="noreferrer">fhs-install-v2ray</a> 安装 v2ray。</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bash</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://raw.githubusercontent.com/v2fly/fhs-install-v2ray/master/install-release.sh)</span></span></code></pre></div><p><img src="https://cdn.tangjiayan.com/reinstall-v2ray/3-instal-v2ray.png" alt="instal-v2ray"></p><p>根据安装完成后的提示，顺便运行一下：</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> purge</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> curl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> unzip</span></span></code></pre></div><p>接下来的步骤我用 <a href="https://www.netsarang.com/en/free-for-home-school/" target="_blank" rel="noreferrer">Xshell for home/school</a> 作为 <a href="https://en.wikipedia.org/wiki/Command-line_interface" target="_blank" rel="noreferrer">CLI</a>，用 <a href="https://www.bitvise.com/">Bitvise</a> 进行 <a href="https://en.wikipedia.org/wiki/SSH_File_Transfer_Protocol" target="_blank" rel="noreferrer">SFTP</a> 文件修改、传输。</p><h2 id="配置-v2ray" tabindex="-1">配置 v2ray <a class="header-anchor" href="#配置-v2ray" aria-label="Permalink to &quot;配置 v2ray&quot;">​</a></h2><p>配置 <code>/usr/local/etc/v2ray/config.json</code>，内容如下</p><details class="details custom-block"><summary>config.json</summary><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;log&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;loglevel&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;warning&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;routing&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;domainStrategy&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;AsIs&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;rules&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:[</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                &quot;type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;field&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                &quot;ip&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:[</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                    &quot;geoip:private&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                ],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                &quot;outboundTag&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;block&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;inbounds&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:[</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;listen&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;127.0.0.1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;port&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">&lt;端口&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;protocol&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;vmess&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;settings&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                &quot;clients&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:[</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                        &quot;id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">&lt;uuid&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                        &quot;alterId&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;streamSettings&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                &quot;network&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ws&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                &quot;wsSettings&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                    &quot;path&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">&lt;path&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;outbounds&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:[</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;protocol&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;freedom&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;tag&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;direct&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;protocol&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;blackhole&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;tag&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;block&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div></details><p>其中：</p><ul><li><code>&lt;端口&gt;</code>：自定</li><li><code>&lt;uuid&gt;</code>：可通过 <a href="https://www.v2fly.org/awesome/tools.html#%E5%9C%A8%E7%BA%BF%E5%B7%A5%E5%85%B7" target="_blank" rel="noreferrer">UUID 生成器</a> 或 <a href="https://www.uuidgenerator.net/" target="_blank" rel="noreferrer">Online UUID Generator</a> 生成</li><li><code>&lt;path&gt;</code>：自定</li></ul><p><code>&lt;uuid&gt;</code> 和 <code>&lt;path&gt;</code> 记得用 <code>英文引号</code> 括起来。</p><h2 id="cloudflare-域名解析" tabindex="-1">CloudFlare 域名解析 <a class="header-anchor" href="#cloudflare-域名解析" aria-label="Permalink to &quot;CloudFlare 域名解析&quot;">​</a></h2><p>CloudFlare 接管了域名解析之后，在 CloudFlare 添加以下两条 DNS 记录：</p>`,47),k=s("table",null,[s("thead",null,[s("tr",null,[s("th",{style:{"text-align":"center"}},"Type"),s("th",{style:{"text-align":"center"}},"Name"),s("th",{style:{"text-align":"center"}},"IPv4 address"),s("th",{style:{"text-align":"center"}},"Proxy statis")])]),s("tbody",null,[s("tr",null,[s("td",{style:{"text-align":"center"}},"A"),s("td",{style:{"text-align":"center"}},"@"),s("td",{style:{"text-align":"center"}},"x.x.x.x"),s("td",{style:{"text-align":"center"}},"☁ Proxied")]),s("tr",null,[s("td",{style:{"text-align":"center"}},"A"),s("td",{style:{"text-align":"center"}},"www"),s("td",{style:{"text-align":"center"}},"x.x.x.x"),s("td",{style:{"text-align":"center"}},"☁ Proxied")])])],-1),d=a(`<h2 id="安装-nginx-及其初始配置" tabindex="-1">安装 Nginx 及其初始配置 <a class="header-anchor" href="#安装-nginx-及其初始配置" aria-label="Permalink to &quot;安装 Nginx 及其初始配置&quot;">​</a></h2><p>参考 <a href="https://ericclose.github.io/V2Ray-TLS-WebSocket-Nginx-with-Cloudflare.html#%E5%AE%89%E8%A3%85-Nginx-%E5%8F%8A%E5%85%B6%E5%88%9D%E5%A7%8B%E9%85%8D%E7%BD%AE" target="_blank" rel="noreferrer">安装 Nginx 及其初始配置</a></p><h2 id="cloudflare-生成-tls-证书、部署-authenticated-origin-pulls" tabindex="-1">CloudFlare 生成 TLS 证书、部署 Authenticated Origin Pulls <a class="header-anchor" href="#cloudflare-生成-tls-证书、部署-authenticated-origin-pulls" aria-label="Permalink to &quot;CloudFlare 生成 TLS 证书、部署 Authenticated Origin Pulls&quot;">​</a></h2><h3 id="tls-证书及私钥" tabindex="-1">TLS 证书及私钥 <a class="header-anchor" href="#tls-证书及私钥" aria-label="Permalink to &quot;TLS 证书及私钥&quot;">​</a></h3><p><code>CloudFlare 仪表盘</code> → <code>SSL/TLS</code> → <code>Origin Server</code> → <code>Create Certificate</code></p><p>因为「The private key data will not be stored at Cloudflare and will no longer be accessible once the creation is complete」，所以要保存好。</p><p><img src="https://cdn.tangjiayan.com/reinstall-v2ray/5-Cloudflare-TLS-Generate.png" alt="Cloudflare-TLS-Generate"></p><p>把证书和私钥都保存在 <code>/etc/ssl/cloudflare</code> 内。</p><h3 id="authenticated-origin-pulls" tabindex="-1">Authenticated Origin Pulls <a class="header-anchor" href="#authenticated-origin-pulls" aria-label="Permalink to &quot;Authenticated Origin Pulls&quot;">​</a></h3><blockquote><p>When you enable Authenticated Origin Pulls for a zone, all proxied traffic to your zone is authenticated at the origin web server. —— <a href="https://developers.cloudflare.com/ssl/origin-configuration/authenticated-origin-pull/set-up/zone-level/#zone-level-authenticated-origin-pulls">Zone-level authenticated origin pulls · Cloudflare SSL/TLS docs</a></p></blockquote><p>也就是说，如果在 Nginx 服务器上设置了 <code>Authenticated Origin Pulls</code>，就可以确保它只接受来自 Cloudflare 服务器的请求，防止任何其他人直接连接到 Nginx 服务器。</p><p>复制 <code>authenticated_origin_pull_ca.pem</code> 证书的内容，同样放在 <code>/etc/ssl/cloudflare</code> 内。</p><details class="details custom-block"><summary>authenticated_origin_pull_ca.pem</summary><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>-----BEGIN CERTIFICATE-----</span></span>
<span class="line"><span>MIIGCjCCA/KgAwIBAgIIV5G6lVbCLmEwDQYJKoZIhvcNAQENBQAwgZAxCzAJBgNV</span></span>
<span class="line"><span>BAYTAlVTMRkwFwYDVQQKExBDbG91ZEZsYXJlLCBJbmMuMRQwEgYDVQQLEwtPcmln</span></span>
<span class="line"><span>aW4gUHVsbDEWMBQGA1UEBxMNU2FuIEZyYW5jaXNjbzETMBEGA1UECBMKQ2FsaWZv</span></span>
<span class="line"><span>cm5pYTEjMCEGA1UEAxMab3JpZ2luLXB1bGwuY2xvdWRmbGFyZS5uZXQwHhcNMTkx</span></span>
<span class="line"><span>MDEwMTg0NTAwWhcNMjkxMTAxMTcwMDAwWjCBkDELMAkGA1UEBhMCVVMxGTAXBgNV</span></span>
<span class="line"><span>BAoTEENsb3VkRmxhcmUsIEluYy4xFDASBgNVBAsTC09yaWdpbiBQdWxsMRYwFAYD</span></span>
<span class="line"><span>VQQHEw1TYW4gRnJhbmNpc2NvMRMwEQYDVQQIEwpDYWxpZm9ybmlhMSMwIQYDVQQD</span></span>
<span class="line"><span>ExpvcmlnaW4tcHVsbC5jbG91ZGZsYXJlLm5ldDCCAiIwDQYJKoZIhvcNAQEBBQAD</span></span>
<span class="line"><span>ggIPADCCAgoCggIBAN2y2zojYfl0bKfhp0AJBFeV+jQqbCw3sHmvEPwLmqDLqynI</span></span>
<span class="line"><span>42tZXR5y914ZB9ZrwbL/K5O46exd/LujJnV2b3dzcx5rtiQzso0xzljqbnbQT20e</span></span>
<span class="line"><span>ihx/WrF4OkZKydZzsdaJsWAPuplDH5P7J82q3re88jQdgE5hqjqFZ3clCG7lxoBw</span></span>
<span class="line"><span>hLaazm3NJJlUfzdk97ouRvnFGAuXd5cQVx8jYOOeU60sWqmMe4QHdOvpqB91bJoY</span></span>
<span class="line"><span>QSKVFjUgHeTpN8tNpKJfb9LIn3pun3bC9NKNHtRKMNX3Kl/sAPq7q/AlndvA2Kw3</span></span>
<span class="line"><span>Dkum2mHQUGdzVHqcOgea9BGjLK2h7SuX93zTWL02u799dr6Xkrad/WShHchfjjRn</span></span>
<span class="line"><span>aL35niJUDr02YJtPgxWObsrfOU63B8juLUphW/4BOjjJyAG5l9j1//aUGEi/sEe5</span></span>
<span class="line"><span>lqVv0P78QrxoxR+MMXiJwQab5FB8TG/ac6mRHgF9CmkX90uaRh+OC07XjTdfSKGR</span></span>
<span class="line"><span>PpM9hB2ZhLol/nf8qmoLdoD5HvODZuKu2+muKeVHXgw2/A6wM7OwrinxZiyBk5Hh</span></span>
<span class="line"><span>CvaADH7PZpU6z/zv5NU5HSvXiKtCzFuDu4/Zfi34RfHXeCUfHAb4KfNRXJwMsxUa</span></span>
<span class="line"><span>+4ZpSAX2G6RnGU5meuXpU5/V+DQJp/e69XyyY6RXDoMywaEFlIlXBqjRRA2pAgMB</span></span>
<span class="line"><span>AAGjZjBkMA4GA1UdDwEB/wQEAwIBBjASBgNVHRMBAf8ECDAGAQH/AgECMB0GA1Ud</span></span>
<span class="line"><span>DgQWBBRDWUsraYuA4REzalfNVzjann3F6zAfBgNVHSMEGDAWgBRDWUsraYuA4REz</span></span>
<span class="line"><span>alfNVzjann3F6zANBgkqhkiG9w0BAQ0FAAOCAgEAkQ+T9nqcSlAuW/90DeYmQOW1</span></span>
<span class="line"><span>QhqOor5psBEGvxbNGV2hdLJY8h6QUq48BCevcMChg/L1CkznBNI40i3/6heDn3IS</span></span>
<span class="line"><span>zVEwXKf34pPFCACWVMZxbQjkNRTiH8iRur9EsaNQ5oXCPJkhwg2+IFyoPAAYURoX</span></span>
<span class="line"><span>VcI9SCDUa45clmYHJ/XYwV1icGVI8/9b2JUqklnOTa5tugwIUi5sTfipNcJXHhgz</span></span>
<span class="line"><span>6BKYDl0/UP0lLKbsUETXeTGDiDpxZYIgbcFrRDDkHC6BSvdWVEiH5b9mH2BON60z</span></span>
<span class="line"><span>0O0j8EEKTwi9jnafVtZQXP/D8yoVowdFDjXcKkOPF/1gIh9qrFR6GdoPVgB3SkLc</span></span>
<span class="line"><span>5ulBqZaCHm563jsvWb/kXJnlFxW+1bsO9BDD6DweBcGdNurgmH625wBXksSdD7y/</span></span>
<span class="line"><span>fakk8DagjbjKShYlPEFOAqEcliwjF45eabL0t27MJV61O/jHzHL3dknXeE4BDa2j</span></span>
<span class="line"><span>bA+JbyJeUMtU7KMsxvx82RmhqBEJJDBCJ3scVptvhDMRrtqDBW5JShxoAOcpFQGm</span></span>
<span class="line"><span>iYWicn46nPDjgTU0bX1ZPpTpryXbvciVL5RkVBuyX2ntcOLDPlZWgxZCBp96x07F</span></span>
<span class="line"><span>AnOzKgZk4RzZPNAxCXERVxajn/FLcOhglVAKo5H0ac+AitlQ0ip55D2/mf8o72tM</span></span>
<span class="line"><span>fVQ6VpyjEXdiIXWUq/o=</span></span>
<span class="line"><span>-----END CERTIFICATE-----</span></span></code></pre></div></details><p><img src="https://cdn.tangjiayan.com/reinstall-v2ray/cloudflare-tls-auth.png" alt="save-the-TLS"></p><h2 id="nginx-证书和密钥、反向代理的配置" tabindex="-1">Nginx 证书和密钥、反向代理的配置 <a class="header-anchor" href="#nginx-证书和密钥、反向代理的配置" aria-label="Permalink to &quot;Nginx 证书和密钥、反向代理的配置&quot;">​</a></h2><p>参考 <a href="https://ericclose.github.io/V2Ray-TLS-WebSocket-Nginx-with-Cloudflare.html#Nginx-%E8%AF%81%E4%B9%A6%E5%92%8C%E5%AF%86%E9%92%A5%E3%80%81%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E7%9A%84%E9%85%8D%E7%BD%AE" target="_blank" rel="noreferrer">Nginx 证书和密钥、反向代理的配置</a> 。</p><p>对于本文需要注意的是，我在上文把 CloudFlare 的证书都放在了 <code>/etc/ssl/cloudflare</code> 下，因此 <code>ssl_certificate</code>、<code>ssl_certificate_key</code>、<code>ssl_client_certificate</code> 需要对应修改。</p><h2 id="后续步骤" tabindex="-1">后续步骤 <a class="header-anchor" href="#后续步骤" aria-label="Permalink to &quot;后续步骤&quot;">​</a></h2><p>后续步骤：</p><ul><li>自启并启动相关服务</li><li>TCP BBR</li><li>v2rayN 客户端配置</li><li>优选 CloudFlare CDN 节点 IP</li></ul><p>参考 <a href="https://ericclose.github.io/V2Ray-TLS-WebSocket-Nginx-with-Cloudflare.html#%E8%87%AA%E5%90%AF%E5%B9%B6%E5%90%AF%E5%8A%A8%E7%9B%B8%E5%85%B3%E6%9C%8D%E5%8A%A1" target="_blank" rel="noreferrer">V2Ray (WebSocket + TLS + Web + Cloudflare) 手动配置详细说明 - Eric</a></p><h2 id="参考" tabindex="-1">参考 <a class="header-anchor" href="#参考" aria-label="Permalink to &quot;参考&quot;">​</a></h2><ul><li><a href="https://ericclose.github.io/V2Ray-TLS-WebSocket-Nginx-with-Cloudflare.html" target="_blank" rel="noreferrer">V2Ray (WebSocket + TLS + Web + Cloudflare) 手动配置详细说明 - Eric</a></li><li><a href="https://www.ddddl.com/archives/1648/debian-apt%E6%9B%B4%E6%96%B0%E5%A4%B1%E8%B4%A5%E5%A4%84%E7%90%86%E6%96%B9%E6%B3%95/" target="_blank" rel="noreferrer">Debian apt更新失败处理方法 – 幽静森林</a></li><li><a href="https://guide.v2fly.org/" target="_blank" rel="noreferrer">V2Ray 配置指南 | 新 V2Ray 白话文指南</a></li></ul>`,23);function c(g,E,u,y,F,C){const i=p("font");return h(),e("div",null,[o,l(i,{color:"#d56d28"},{default:t(()=>[k]),_:1}),d])}const f=n(r,[["render",c]]);export{B as __pageData,f as default};
